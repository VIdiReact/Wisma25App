<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisma App</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
	
    <style>
        :root { 
            --bg: #f0f2f5; --kosong: #2ecc71; --terisi: #e74c3c; 
            --ackipas: #f1c40f; --kotor: #3498db; --maintenance: #7f8c8d; --primary: #2c3e50; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        .hidden { display: none !important; }
        .readonly-mode .admin-only { display: none !important; }
        
        header { position: sticky; top: 0; z-index: 100; background: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-header { padding: 8px 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.7rem; margin-left: 5px; }
        
        .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; padding: 15px; }
        .room-card { background: white; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; border-left: 8px solid #ddd; box-shadow: 0 3px 6px rgba(0,0,0,0.05); min-height: 250px; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        
        .status-kosong { border-left-color: var(--kosong); }
        .status-terisi { border-left-color: var(--terisi); }
        .status-ac-kipas { border-left-color: var(--ackipas); }
        .status-kotor { border-left-color: var(--kotor); }
        .status-maintenance { border-left-color: var(--maintenance); }

        .room-number { font-size: 1.8rem; font-weight: 800; color: #333; }
        .room-footnote { font-size: 0.65rem; color: #444; background: #f8f9fa; padding: 6px; border-radius: 6px; border: 1px solid #e9ecef; margin-top: 5px; text-align: left; line-height: 1.3; }
        .co-tag { color: red; font-weight: bold; font-size: 0.75rem; } 
        .kendala-text { color: #e67e22; font-weight: bold; display: block; margin-top: 3px; border-top: 1px dashed #ccc; padding-top: 2px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; padding: 10px; }
        .modal-content { background: white; border-radius: 15px; width: 100%; max-width: 800px; padding: 20px; max-height: 95vh; overflow-y: auto; position: relative; }
        
        label { font-size: 0.75rem; font-weight: bold; color: #555; display: block; margin-top: 8px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; margin-top: 4px; }
        .btn-main { background: var(--primary); color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        
        .emp-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .emp-table tr { border-bottom: 1px solid #eee; }
        .emp-table td { padding: 12px 8px; }
        .btn-del-red { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; float: right; font-weight: bold; }

        .editable-cell { background: #fffde7; cursor: text; border: 1px dashed #ccc; padding: 4px; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-bottom: 20px; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    </style>
</head>
<body id="mainBody">

<div id="loginPage" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--primary); z-index:2000; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; padding:40px; border-radius:20px; text-align:center; width:320px;">
        <h1 style="color:var(--primary); margin-bottom:30px;">WISMA 25</h1>
        <div id="loginStep1">
            <button class="btn-main" onclick="prepLogin()">Resepsionis (Admin)</button>
            <button class="btn-main" style="background:#7f8c8d" onclick="login('Karyawan')">Login Karyawan</button>
        </div>
        <div id="loginStep2" class="hidden">
            <input type="password" id="passInput" placeholder="Sandi Admin" autofocus onkeypress="if(event.key==='Enter') checkPass()">
            <button class="btn-main" onclick="checkPass()">MASUK (Enter)</button>
            <button style="background:none; border:none; color:gray; cursor:pointer; margin-top:10px;" onclick="location.reload()">Kembali</button>
        </div>
    </div>
</div>

<header>
    <div><b style="font-size: 0.8rem;">WISMA 25 PUTRI MELAYU <span id="roleLabel" style="font-size:0.7rem; opacity:0.6"></span></b></div>
    <div id="navMenu">
        <button class="btn-header admin-only" style="background:#2980b9" onclick="window.open('Kasir25.html', '_blank')">üõí KASIR</button>
        <button class="btn-header admin-only" style="background:#e67e22" onclick="openM('expenseModal')">üí∏ PENGELUARAN</button>
        <button class="btn-header admin-only" style="background:#34495e" onclick="openLoanModal()">KASBON</button>
        <button class="btn-header admin-only" style="background:#8e44ad" onclick="openReportFilter()">LAPORAN</button>
        <button class="btn-header admin-only" style="background:#16a085" onclick="openM('employeeModal')">KARYAWAN</button>
        <button class="btn-header" style="background:#c0392b" onclick="logout()">OUT</button>
    </div>
</header>

<div class="container" id="roomContainer"></div>

<div class="modal" id="roomModal">
    <div class="modal-content">
        <div id="modalStep1">
            <h2 id="roomTitle"></h2>
            <div id="roomActions"></div>
            <button class="btn-main" style="background:#95a5a6" onclick="closeM('roomModal')">Tutup (Esc)</button>
        </div>
        <div id="modalStep2" class="hidden">
            <h3>Check-In Kamar <span id="targetRoomDisplay"></span> (<span id="ciTypeLabel"></span>)</h3>
            <label>1. Nama Tamu</label><input type="text" id="gName" onkeypress="focusNext(event, 'gNik')">
            <label>2. NIK (Identitas)</label><input type="number" id="gNik" onkeypress="focusNext(event, 'gHp')">
            <label>3. Nomor HP Tamu</label><input type="number" id="gHp" onkeypress="focusNext(event, 'gAddress')">
            <label>4. Alamat Lengkap</label><textarea id="gAddress" rows="2" onkeypress="focusNext(event, 'gGuarantee')"></textarea>
            <label>5. Jaminan</label>
            <select id="gGuarantee" onchange="toggleGuarantee()"><option value="KTP">KTP</option><option value="SIM">SIM</option><option value="Lainnya">Lainnya...</option><option value="Tidak Ada">Tidak Ada (Deposit)</option></select>
            <div id="depositArea" class="hidden"><label>6. Nominal Deposit Rp</label><input type="number" id="gDeposit"></div>
            <label>7. Tanggal & Jam</label><input type="text" id="gTime" readonly>
            <label>8. Status Bayar</label><select id="gStatusBayar" onchange="togglePayDetail()"><option value="Lunas">Lunas</option><option value="Kurang">Belum Lunas</option></select>
            <div id="payDetailArea"></div>
            <label>10. Jenis Kamar</label><input type="text" id="gType" readonly>
            <label>11. Harga Kamar (Satuan)</label><input type="number" id="gPrice" readonly>
            <label>12. Nomor Kamar</label><input type="text" id="gRoomId" readonly>
            <label>13. Lama Menginap (Hari)</label><input type="number" id="gDuration" value="1" min="1" oninput="calcTotalCheckIn()">
            <div style="margin-top:10px; font-weight:bold; color:var(--terisi)">Total Bayar: Rp <span id="gTotalDisplay">0</span></div>
            <button class="btn-main admin-only" style="background:#27ae60" onclick="processCheckIn()">PROSES (Enter)</button>
            <button class="btn-main" style="background:#95a5a6" onclick="backToStep1()">Batal</button>
        </div>
    </div>
</div>

<div class="modal" id="loanModal">
    <div class="modal-content">
        <h3>Pinjaman / Kasbon Karyawan</h3>
        <label>Pilih Karyawan</label><select id="loanEmpSelect"></select>
        <label>Nominal Pinjaman Rp</label><input type="number" id="loanAmount" onkeypress="if(event.key==='Enter') saveLoan()">
        <button class="btn-main" style="background:#2ecc71" onclick="saveLoan()">Simpan Kasbon</button>
        <hr>
        <h4>Rekap Berdasarkan Rentang Tanggal</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <div><label>Dari Tanggal</label><input type="date" id="rekapStart"></div>
            <div><label>Sampai Tanggal</label><input type="date" id="rekapEnd"></div>
        </div>
        <button class="btn-main" style="background:#34495e" onclick="showLoanRekapDate()">LIHAT REKAP</button>
        <button class="btn-main" style="background:gray" onclick="closeM('loanModal')">Tutup</button>
    </div>
</div>

<div class="modal" id="employeeModal">
    <div class="modal-content">
        <h3>Kelola Karyawan</h3>
        <div style="display:flex; gap:5px">
            <input type="text" id="newEmpName" placeholder="Nama Karyawan Baru">
            <button onclick="addEmployee()" style="background:var(--kosong); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer">Tambah</button>
        </div>
        <div style="margin-top:15px; border:1px solid #ddd; border-radius:8px;">
            <table class="emp-table" id="employeeListArea"></table>
        </div>
        <button class="btn-main" style="background:gray" onclick="closeM('employeeModal')">Tutup</button>
    </div>
</div>

<div class="modal" id="editReportModal">
    <div class="modal-content" style="max-width:98%">
        <h3 id="previewTitle">Preview Laporan (Mode Edit)</h3>
        <div id="reportPreviewArea" style="overflow-x:auto" oninput="recalcAndReorder()"></div>
        <div id="grandTotalArea" style="background:#f8f9fa; color:#333; padding:15px; border:2px solid var(--primary); border-radius:8px; margin-top:10px; font-weight:bold"></div>
        <button class="btn-main" style="background:#27ae60" onclick="exportToPDF()">CETAK KE PDF (Enter)</button>
        <button class="btn-main" style="background:gray" onclick="closeM('editReportModal')">Kembali (Esc)</button>
    </div>
</div>

<div class="modal" id="reportFilterModal">
    <div class="modal-content">
        <h3>Filter Laporan</h3>
        <label>Dari (Tanggal & Jam)</label><input type="datetime-local" id="repStart">
        <label>Sampai (Tanggal & Jam)</label><input type="datetime-local" id="repEnd">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
            <button class="btn-main" style="background:#3498db" onclick="prepareReport('abang')">LAPORAN ABANG</button>
            <button class="btn-main" style="background:#9b59b6" onclick="prepareReport('kakak')">LAPORAN KAKAK</button>
        </div>
        <button class="btn-main" style="background:gray" onclick="closeM('reportFilterModal')">Batal</button>
    </div>
</div>

<div class="modal" id="expenseModal">
    <div class="modal-content">
        <h3>Tambah Pengeluaran</h3>
        <label>Keterangan Pengeluaran</label><input type="text" id="expNote" placeholder="Contoh: Beli Sabun">
        <label>Nominal Rp</label><input type="number" id="expAmount" onkeypress="if(event.key==='Enter') saveExpense()">
        <button class="btn-main" onclick="saveExpense()">Simpan Pengeluaran</button>
        <button class="btn-main" style="background:gray" onclick="closeM('expenseModal')">Batal</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyA2rvSdY-gZOjauf0zlCpNgW3Nu5hbi4y4", authDomain: "wisma25v3.firebaseapp.com", databaseURL: "https://wisma25v3-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "wisma25v3" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let fullRooms = {}, currentRoomId = null, currentMode = "", checkInType = "Baru";
    let globalSums = { sewa: 0, pengeluaran: 0, kasbon: 0 };

    window.onkeydown = (e) => { 
        if(e.key === "Escape") document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
        if(e.key === "Enter") {
            if(document.getElementById('editReportModal').style.display === 'flex') exportToPDF();
            else if(document.getElementById('modalStep2').style.display === 'block') processCheckIn();
        }
    };

    window.onload = () => { 
        if(localStorage.getItem('wismaRole')) login(localStorage.getItem('wismaRole')); 
        document.getElementById('passInput').focus();
    };
    
    function prepLogin() { 
        document.getElementById('loginStep1').classList.add('hidden'); 
        document.getElementById('loginStep2').classList.remove('hidden');
        setTimeout(() => document.getElementById('passInput').focus(), 100); 
    }

    function checkPass() { if(document.getElementById('passInput').value === "877887") { localStorage.setItem('wismaRole', 'Resepsionis'); login('Resepsionis'); } else alert("Sandi Salah!"); }
    
    function login(role) {
        localStorage.setItem('wismaRole', role);
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('roleLabel').innerText = "| " + role;
        if(role === 'Karyawan') document.getElementById('mainBody').classList.add('readonly-mode');
        else document.getElementById('mainBody').classList.remove('readonly-mode');
        
        db.ref('rooms').on('value', snap => { fullRooms = snap.val() || {}; renderGrid(); });
        syncEmployees();
    }
    
    function logout() { localStorage.removeItem('wismaRole'); location.reload(); }

    function renderGrid() {
        const cont = document.getElementById('roomContainer'); cont.innerHTML = '';
        const statusOrder = ['Kosong', 'Terisi', 'AC/Kipas', 'Kotor', 'Maintenance'];
        let roomArr = [];
        for(let i=1; i<=24; i++) {
            const id = i.toString().padStart(2, '0');
            roomArr.push({id: id, ...(fullRooms[id] || { status: 'Kosong' })});
        }
        roomArr.sort((a,b) => statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status));

        roomArr.forEach(r => {
            let css = r.status.toLowerCase().replace(/\//g, '-').replace(/ /g, '-');
            let coTag = r.isCO ? '<span class="co-tag"> (CO)</span>' : '';
            let kendalaHtml = (r.kendala) ? `<span class="kendala-text">‚ö†Ô∏è ${r.kendala}</span>` : '';
            let fn = r.status === 'Maintenance' ? `<div class="room-footnote" style="color:red">‚ö†Ô∏è ${r.keterangan || 'RUSAK'}</div>` : 
                     `<div class="room-footnote"><b>Nama:</b> ${r.guestName || '-'}<br><b>Depo:</b> Rp ${(r.deposit || 0).toLocaleString()} | <b>Sisa:</b> Rp ${(r.kurang || 0).toLocaleString()}${kendalaHtml}</div>`;

            cont.innerHTML += `<div class="room-card status-${css}" onclick="openRoom('${r.id}')">
                <div style="font-size:0.7rem; font-weight:bold">${parseInt(r.id) <= 5 ? 'NON-AC' : 'AC'}</div>
                <div class="room-number">${r.id}</div>
                <div style="font-size:0.8rem; font-weight:bold">${r.status}${coTag}</div>
                ${fn}
            </div>`;
        });
    }

    function openRoom(id) {
        currentRoomId = id; const r = fullRooms[id] || { status: 'Kosong' };
        document.getElementById('roomTitle').innerText = "Kamar " + id;
        const acts = document.getElementById('roomActions'); acts.innerHTML = '';
        
        if(r.status === 'Kosong') {
            acts.innerHTML = `
                <button class="btn-main admin-only" style="background:#27ae60" onclick="showCheckIn('Baru')">Check-In Baru</button>
                <button class="btn-main admin-only" style="background:#2980b9" onclick="showCheckIn('Menyambung setengah hari')">Menyambung 1/2 Hari</button>
                <button class="btn-main admin-only" style="background:#8e44ad" onclick="showCheckIn('Menyambung satu hari')">Menyambung 1 Hari</button>
            `;
        } else if(r.status === 'Terisi' || r.status === 'AC/Kipas') {
            if(r.status === 'Terisi') acts.innerHTML += `<button class="btn-main admin-only" style="background:#e67e22" onclick="moveRoom()">Pindah Kamar</button>`;
            acts.innerHTML += `<button class="btn-main admin-only" style="background:var(--kotor)" onclick="checkOut()">Check-Out (Bersihkan)</button>`;
        } else if(r.status === 'Kotor') {
            let kndHtml = r.kendala ? `<div style="color:red; margin:10px 0; font-size:0.8rem">Kendala: ${r.kendala}</div>` : '';
            acts.innerHTML = kndHtml + `<button class="btn-main admin-only" onclick="updateStatus('Kosong')">Selesai Bersihkan (Kosongkan)</button>`;
        }
        
        if(r.status === 'Maintenance') acts.innerHTML = `<button class="btn-main admin-only" style="background:var(--kosong)" onclick="updateStatus('Kosong')">Selesai Perbaikan</button>`;
        else acts.innerHTML += `<button class="btn-main admin-only" style="background:var(--maintenance)" onclick="promptMaint()">Maintenance</button>`;
        openM('roomModal');
    }

    function showCheckIn(type) { 
        checkInType = type; const id = currentRoomId; 
        let basePrice = parseInt(id) <= 5 ? 150000 : 200000;
        if(type === 'Menyambung setengah hari') basePrice = 100000;
        document.getElementById('ciTypeLabel').innerText = type;
        document.getElementById('gRoomId').value = id;
        document.getElementById('gPrice').value = basePrice;
        document.getElementById('gType').value = parseInt(id) <= 5 ? 'NON-AC' : 'AC';
        document.getElementById('gTime').value = new Date().toLocaleString('id-ID');
        document.getElementById('modalStep1').classList.add('hidden'); 
        document.getElementById('modalStep2').classList.remove('hidden'); 
        calcTotalCheckIn();
        setTimeout(() => document.getElementById('gName').focus(), 100); 
    }

    function calcTotalCheckIn() {
        const p = parseInt(document.getElementById('gPrice').value) || 0;
        const d = parseInt(document.getElementById('gDuration').value) || 1;
        document.getElementById('gTotalDisplay').innerText = (p * d).toLocaleString();
    }

    function processCheckIn() {
        const price = parseInt(document.getElementById('gPrice').value);
        const dur = parseInt(document.getElementById('gDuration').value);
        const total = price * dur;
        const newTransRef = db.ref('transactions').push();
        const d = { 
            id: currentRoomId, status: "Terisi", ciType: checkInType,
            guestName: document.getElementById('gName').value, nik: document.getElementById('gNik').value, 
            hp: document.getElementById('gHp').value, address: document.getElementById('gAddress').value, 
            guarantee: document.getElementById('gGuarantee').value, deposit: parseInt(document.getElementById('gDeposit')?.value) || 0,
            kurang: parseInt(document.getElementById('gStatusBayar').value === 'Kurang' ? document.getElementById('gKurang')?.value : 0) || 0, 
            timestamp: Date.now(), price: price, totalPrice: total, duration: dur, isCO: false, transKey: newTransRef.key, kendala: "" 
        };
        newTransRef.set(d);
        db.ref('rooms/'+currentRoomId).set(d).then(() => closeM('roomModal'));
    }

    function checkOut() {
        const r = fullRooms[currentRoomId];
        let knd = confirm("Ada kendala kamar?") ? prompt("Sebutkan kendala:") : "";
        db.ref('rooms/'+currentRoomId).update({ status: 'AC/Kipas', isCO: true, kendala: knd || "" });
        if(r.transKey) db.ref('transactions/'+r.transKey).update({ isCO: true, guestName: r.guestName, kendala: knd || "" });
        setTimeout(() => { db.ref('rooms/'+currentRoomId).update({ status: 'Kotor' }); closeM('roomModal'); }, 500);
    }

    function moveRoom() {
        const target = prompt("Nomor kamar tujuan (01-24):");
        if(!target || target === currentRoomId) return;
        if(fullRooms[target] && fullRooms[target].status !== 'Kosong') return alert("Kamar tujuan tidak kosong!");
        let data = {...fullRooms[currentRoomId]}; let oldId = currentRoomId;
        data.id = target; data.guestName += ` >(${target})`;
        db.ref('rooms/'+target).set(data); db.ref('rooms/'+oldId).set({status:'Kosong'});
        if(data.transKey) db.ref('transactions/'+data.transKey).update({ id: target, guestName: data.guestName });
        closeM('roomModal');
    }

    function openReportFilter() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const defaultTime = `${year}-${month}-${day}T18:00`;
        document.getElementById('repStart').value = defaultTime;
        document.getElementById('repEnd').value = defaultTime;
        openM('reportFilterModal');
    }

    async function prepareReport(mode) {
        currentMode = mode; 
        const startVal = document.getElementById('repStart').value; 
        const endVal = document.getElementById('repEnd').value;
        if(!startVal || !endVal) return alert("Pilih Rentang Tanggal dan Jam!");
        const startTime = new Date(startVal).getTime();
        const endTime = new Date(endVal).getTime();
        const [sT, sE, sL] = await Promise.all([db.ref('transactions').once('value'), db.ref('expenses').once('value'), db.ref('loans').once('value')]);
        let html = '';
        const shifts = [{n:'Pagi/Siang (07-18)', s:7, e:18, id:'Pagi'}, {n:'Malam (18-07)', s:18, e:7, id:'Malam'}];
        
        shifts.forEach(sh => {
            html += `<h4>Tabel Shift ${sh.id}</h4><table class="preview-table" id="table${sh.id}">
            <thead><tr><th>No</th><th>Jam</th><th>Kmr</th><th>Tamu</th><th>Identitas</th><th>Status</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>`;
            let idx = 1;
            sT.forEach(c => {
                const d = c.val(); const dt = new Date(d.timestamp); const hour = dt.getHours();
                const isMatchShift = (sh.s === 7) ? (hour >= 7 && hour < 18) : (hour >= 18 || hour < 7);
                if(d.timestamp >= startTime && d.timestamp <= endTime && isMatchShift) {
                    let price = d.totalPrice;
                    if(mode === 'kakak') price = (d.ciType === 'Menyambung setengah hari') ? 50000 : 140000;
                    html += `<tr><td class="row-num">${idx++}</td><td>${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}</td><td>${d.id}</td><td contenteditable="true" class="editable-cell">${d.guestName}${d.isCO ? ' <span style="color:red">(CO)</span>' : ''}</td><td>${d.nik} / ${d.hp} / ${d.address}</td><td>${d.ciType}</td><td contenteditable="true" class="editable-cell" oninput="recalcAndReorder()">${price}</td><td><button style="background:red; color:white; border:none;" onclick="this.closest('tr').remove(); recalcAndReorder();">Hapus</button></td></tr>`;
                }
            });
            html += `</tbody></table>`;
            
            html += `<h5>Tabel Pengeluaran ${sh.id}</h5><table class="preview-table" id="exp${sh.id}">
            <thead><tr><th>Jam Input</th><th>Keterangan</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>`;
            sE.forEach(c => {
                const d = c.val(); const dt = new Date(d.timestamp); const hour = dt.getHours();
                const isMatchShift = (sh.s === 7) ? (hour >= 7 && hour < 18) : (hour >= 18 || hour < 7);
                if(d.timestamp >= startTime && d.timestamp <= endTime && isMatchShift) {
                    const tStr = `${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
                    html += `<tr><td>${tStr}</td><td contenteditable="true" class="editable-cell">${d.note}</td><td contenteditable="true" class="editable-cell" oninput="recalcAndReorder()">${d.amount}</td><td><button onclick="this.closest('tr').remove(); recalcAndReorder();">X</button></td></tr>`;
                }
            });
            html += `</tbody></table>`;
        });

        if(mode === 'abang') {
            html += `<h4>Tabel Kasbon</h4><table class="preview-table" id="tableLoan">
            <thead><tr><th>Jam Input</th><th>Nama Karyawan</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>`;
            sL.forEach(c => {
                const d = c.val(); const dt = new Date(d.timestamp);
                if(d.timestamp >= startTime && d.timestamp <= endTime) {
                    const tStr = `${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
                    html += `<tr><td>${tStr}</td><td>${d.emp}</td><td contenteditable="true" class="editable-cell" oninput="recalcAndReorder()">${d.amount}</td><td><button onclick="this.closest('tr').remove(); recalcAndReorder();">X</button></td></tr>`;
                }
            });
            html += `</tbody></table>`;
        }
        document.getElementById('reportPreviewArea').innerHTML = html; 
        recalcAndReorder(); openM('editReportModal');
    }

    function recalcAndReorder() {
        ['Pagi', 'Malam'].forEach(sid => { 
            let i = 1; 
            document.querySelectorAll(`#table${sid} tbody tr`).forEach(tr => { tr.querySelector('.row-num').innerText = i++; }); 
        });
        let tsP = 0, tsM = 0, teP = 0, teM = 0, tK = 0;
        document.querySelectorAll('#tablePagi tbody tr').forEach(tr => tsP += parseInt(tr.cells[6].innerText) || 0);
        document.querySelectorAll('#tableMalam tbody tr').forEach(tr => tsM += parseInt(tr.cells[6].innerText) || 0);
        document.querySelectorAll('#expPagi tbody tr').forEach(tr => teP += parseInt(tr.cells[2].innerText) || 0);
        document.querySelectorAll('#expMalam tbody tr').forEach(tr => teM += parseInt(tr.cells[2].innerText) || 0);
        if(currentMode === 'abang') document.querySelectorAll('#tableLoan tbody tr').forEach(tr => tK += parseInt(tr.cells[2].innerText) || 0);
        
        globalSums = { sewa: tsP + tsM, pengeluaran: teP + teM, kasbon: tK, pagi: tsP - teP, malam: tsM - teM };
        
        const rumusTxt = (currentMode === 'kakak') ? "Grand Total = Sewa Kamar - Pengeluaran" : "Grand Total = Sewa Kamar - Pengeluaran - Kasbon";
        document.getElementById('grandTotalArea').innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                <div style="border:1px solid #ddd; padding:5px"><b>Setoran Pagi:</b> Rp ${(globalSums.pagi).toLocaleString()}</div>
                <div style="border:1px solid #ddd; padding:5px"><b>Setoran Malam:</b> Rp ${(globalSums.malam - (currentMode === 'abang' ? tK : 0)).toLocaleString()}</div>
            </div><hr>
            <div>Sewa: Rp ${globalSums.sewa.toLocaleString()} | Pengeluaran: Rp ${globalSums.pengeluaran.toLocaleString()} | Kasbon: Rp ${tK.toLocaleString()}</div>
            <div style="font-size:1.4rem; color:red">GRAND TOTAL: Rp ${(globalSums.sewa - globalSums.pengeluaran - tK).toLocaleString()}</div>
            <div style="font-size:0.7rem; color:gray; font-style:italic">${rumusTxt}</div>
        `;
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const sRaw = document.getElementById('repStart').value.split('T')[0];
        const eRaw = document.getElementById('repEnd').value.split('T')[0];
        doc.setFontSize(16); doc.text("Laporan Wisma 25", 14, 15);
        doc.setFontSize(9); 
        const tglText = (sRaw === eRaw) ? formatDate(sRaw) : `${formatDate(sRaw)} - ${formatDate(eRaw)}`;
        doc.text(tglText, 196, 15, { align: 'right' });

        let finalY = 20;
        const sections = [
            {id:'tablePagi', title:'Shift Pagi/Siang'}, {id:'expPagi', title:'Tabel Pengeluaran Pagi'}, 
            {id:'tableMalam', title:'Shift Malam'}, {id:'expMalam', title:'Tabel Pengeluaran Malam'}
        ];
        if(currentMode === 'abang') sections.push({id:'tableLoan', title:'Tabel Kasbon'});

        sections.forEach(s => {
            if(document.querySelector(`#${s.id} tbody tr`)) {
                doc.setFontSize(10); doc.text(s.title, 14, finalY + 10);
                doc.autoTable({ html: `#${s.id}`, startY: finalY + 12, theme: 'grid', styles: { fontSize: 7 } });
                finalY = doc.lastAutoTable.finalY;
            }
        });

        doc.setFontSize(11); 
        doc.text(`Sewa Kamar: Rp ${globalSums.sewa.toLocaleString()}`, 14, finalY + 15);
        doc.text(`Pengeluaran: Rp ${globalSums.pengeluaran.toLocaleString()}`, 14, finalY + 21);
        if(currentMode === 'abang') doc.text(`Kasbon: Rp ${globalSums.kasbon.toLocaleString()}`, 14, finalY + 27);
        
        doc.setFontSize(14); doc.text(`GRAND TOTAL: Rp ${(globalSums.sewa - globalSums.pengeluaran - globalSums.kasbon).toLocaleString()}`, 14, finalY + 36);
        doc.setFontSize(7); 
        doc.text((currentMode === 'kakak') ? "Grand Total = Sewa Kamar - Pengeluaran" : "Grand Total = Sewa Kamar - Pengeluaran - Kasbon", 14, finalY + 41);
        doc.save(`Laporan_Wisma25.pdf`);
    }

    function formatDate(d) { if(!d) return ''; const [y,m,day] = d.split('-'); return `${day}-${m}-${y}`; }
    function updateStatus(s, ket = "") { db.ref('rooms/'+currentRoomId).update({ status: s, keterangan: ket, isCO: false, guestName: '---', deposit:0, kurang:0, kendala:'' }).then(()=>closeM('roomModal')); }
    function syncEmployees() { db.ref('employees').on('value', snap => { const area = document.getElementById('employeeListArea'); const s1 = document.getElementById('loanEmpSelect'); area.innerHTML = ''; s1.innerHTML = ''; snap.forEach(c => { area.innerHTML += `<tr style="border-bottom:1px solid #ddd"><td>${c.val().name}</td><td><button class="btn-del-red admin-only" onclick="delEmp('${c.key}')">Hapus</button></td></tr>`; s1.innerHTML += `<option value="${c.val().name}">${c.val().name}</option>`; }); }); }
    function addEmployee() { const n = document.getElementById('newEmpName').value; if(n) db.ref('employees').push({name:n}).then(()=>document.getElementById('newEmpName').value=''); }
    function delEmp(k) { if(confirm('Hapus Karyawan?')) db.ref('employees/'+k).remove(); }
    function saveExpense() { db.ref('expenses').push({note:document.getElementById('expNote').value, amount:parseInt(document.getElementById('expAmount').value), timestamp:Date.now()}).then(()=> { document.getElementById('expNote').value=''; document.getElementById('expAmount').value=''; closeM('expenseModal'); }); }
    function saveLoan() { db.ref('loans').push({emp:document.getElementById('loanEmpSelect').value, amount:parseInt(document.getElementById('loanAmount').value), timestamp:Date.now()}).then(()=> { document.getElementById('loanAmount').value=''; alert('Kasbon Tersimpan!'); }); }
    async function showLoanRekapDate() { 
        const s = document.getElementById('rekapStart').value; const e = document.getElementById('rekapEnd').value;
        if(!s || !e) return alert("Pilih rentang tanggal!");
        const snap = await db.ref('loans').once('value'); let rekap = {};
        snap.forEach(c => { const d = c.val(); const dDate = new Date(d.timestamp).toISOString().split('T')[0]; if(dDate >= s && dDate <= e) rekap[d.emp] = (rekap[d.emp] || 0) + d.amount; });
        let txt = `REKAP KASBON (${s} s/d ${e}):\n`; for(let n in rekap) txt += `- ${n}: Rp ${rekap[n].toLocaleString()}\n`; alert(txt);
    }
    function promptMaint() { const k = prompt("Keterangan Kerusakan:"); if(k) updateStatus('Maintenance', k); }
    function focusNext(e, id) { if(e.key==='Enter'){ e.preventDefault(); document.getElementById(id).focus(); } }
    function toggleGuarantee() { (document.getElementById('gGuarantee').value === 'Tidak Ada') ? document.getElementById('depositArea').classList.remove('hidden') : document.getElementById('depositArea').classList.add('hidden'); }
    function togglePayDetail() { document.getElementById('payDetailArea').innerHTML = (document.getElementById('gStatusBayar').value === 'Kurang') ? `<label>9. Sisa Kurang Rp</label><input type="number" id="gKurang">` : ''; }
    function openM(id) { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }
    function closeM(id) { document.getElementById(id).style.display = 'none'; }
    function openLoanModal() { openM('loanModal'); syncEmployees(); }
    function backToStep1() { document.getElementById('modalStep1').classList.remove('hidden'); document.getElementById('modalStep2').classList.add('hidden'); }
</script>
</body>
</html>