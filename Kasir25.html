<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir App</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --accent: #3498db; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        /* Layout Utama */
        .main-content { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; box-sizing: border-box; }
        .left-column { display: flex; flex-direction: column; gap: 20px; overflow: hidden; height: 100%; }
        .right-column { display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .scrollable { overflow-y: auto; flex: 1; padding-right: 5px; }

        /* Rak Barang Rapi (Poin 10) */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .product-item { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 110px; }
        .product-item:hover { border-color: var(--accent); background: #f9f9f9; }
        .p-name { font-weight: bold; font-size: 1rem; color: var(--primary); }
        .p-stock { color: var(--success); font-size: 0.85rem; margin: 5px 0; }
        .p-price { font-weight: bold; color: #e67e22; font-size: 0.95rem; }

        /* Riwayat Shift Tinggi Penuh (Poin 19) */
        .riwayat-card { height: 100%; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        table th { position: sticky; top: 0; background: #eee; z-index: 1; }

        /* Footer & Total Penjualan Besar (Poin 12) */
        footer { background: var(--primary); color: white; padding: 5px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 85px; }
        .footer-left { font-weight: bold; font-size: 1.2rem; }
        .footer-right { text-align: right; line-height: 1; }
        .total-label { font-size: 1rem; margin-right: 10px; }
        .big-price { font-size: 3rem; font-weight: bold; }

        /* Tombol & Input */
        button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-green { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        input { padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 1.1rem; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 450px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 1.8rem; font-weight: bold;">Kasir 25</div> <div id="clock" style="font-size: 1.2rem; font-weight: 500;">00:00 - 01/01/2000</div> </header>

<div class="main-content">
    <div class="left-column">
        <div class="card" style="flex: 2.5;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0;">Menu Jual</h3>
                <button class="btn-blue" onclick="location.href='index3.html'">üè† Kembali</button> </div>
            <div class="product-grid scrollable" id="pos-grid"></div>
        </div>
        
        <div class="card" style="flex: 1;">
            <h3 style="margin:0 0 10px 0;">Shift & Laporan</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-blue" onclick="openModal('modal-staff')">üë§ Petugas</button>
                <button class="btn-blue" onclick="openModal('modal-stok')">üì¶ Cek Stok (G/K)</button> <button class="btn-blue" onclick="openModal('modal-input')">‚ûï Input Barang</button> <button class="btn-blue" style="background:#9b59b6;" onclick="exportPDF()">üñ®Ô∏è Cetak Laporan</button>
            </div>
            <button class="btn-red" style="margin-top:10px;" onclick="resetShift()">üîÑ Ganti Shift (Hapus Tampilan)</button> </div>
    </div>

    <div class="right-column">
        <div class="card riwayat-card">
            <h3 style="margin:0 0 10px 0;">Riwayat Shift Ini</h3>
            <div class="scrollable">
                <table>
                    <thead>
                        <tr><th>Jam</th><th>Barang</th><th>Qty</th><th>Total</th></tr>
                    </thead>
                    <tbody id="sales-log"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-left">PETUGAS: <span id="staff-label">-</span></div>
    <div class="footer-right">
        <span class="total-label">TOTAL PENJUALAN</span>
        <span class="big-price" id="display-total-val">= RP. 0</span>
    </div>
</footer>

<div id="modal-staff" class="modal">
    <div class="modal-content">
        <h3>Ganti Petugas</h3>
        <input type="text" id="staff-input" placeholder="Nama Petugas" autofocus>
        <button class="btn-green" onclick="updateStaff()">Simpan (Enter)</button>
        <button class="btn-red" style="width:100%; margin-top:5px;" onclick="closeModal('modal-staff')">Batal (Esc)</button>
    </div>
</div>

<div id="modal-stok" class="modal">
    <div class="modal-content" style="width: 700px; max-width: 95%;">
        <h3>Stok Gudang & Kulkas</h3>
        <div class="scrollable" style="max-height: 400px;">
            <table>
                <thead><tr><th>Nama Barang</th><th>Gudang</th><th>Kulkas</th><th>Aksi</th></tr></thead>
                <tbody id="stock-list"></tbody>
            </table>
        </div>
        <button class="btn-red" style="width:100%; margin-top:15px;" onclick="closeModal('modal-stok')">Tutup (Esc)</button>
    </div>
</div>

<div id="modal-input" class="modal">
    <div class="modal-content">
        <h3>Input Barang Baru</h3>
        <input type="text" id="p-name" placeholder="Nama Barang">
        <input type="number" id="p-stock-gudang" placeholder="Stok Gudang">
        <input type="number" id="p-stock-kulkas" placeholder="Stok Kulkas">
        <input type="text" id="p-price" placeholder="Harga Jual" onkeyup="formatRupiah(this)">
        <button class="btn-green" onclick="saveProduct()">Simpan Barang (Enter)</button>
        <button class="btn-red" style="width:100%; margin-top:5px;" onclick="closeModal('modal-input')">Batal (Esc)</button>
    </div>
</div>

<div id="modal-sale" class="modal">
    <div class="modal-content">
        <h3>Konfirmasi Pembelian</h3>
        <p id="info-barang-jual" style="font-weight:bold; font-size:1.1rem; color:var(--primary);"></p>
        <label>Jumlah Beli:</label>
        <input type="number" id="buy-qty" value="1" min="1" autofocus>
        <button class="btn-green" onclick="processSale()">Konfirmasi (Enter)</button>
        <button class="btn-red" style="width:100%; margin-top:5px;" onclick="closeModal('modal-sale')">Batal (Esc)</button>
    </div>
</div>

<div id="modal-calc" class="modal">
    <div class="modal-content">
        <h3>Kalkulator Kembalian</h3>
        <p style="font-size:1.1rem;">Total Tagihan: <span id="calc-total" style="font-weight:bold; color:var(--success);">0</span></p>
        <input type="text" id="calc-bayar" placeholder="Masukkan Uang Pembayaran" onkeyup="formatRupiah(this)" autofocus>
        <button class="btn-green" onclick="hitungKembalian()">Hitung Kembalian (Enter)</button>
        <div id="calc-result" style="margin:20px 0; font-weight:bold; font-size:1.8rem; color:var(--danger); text-align:center; min-height:40px;"></div>
        <button class="btn-blue" style="width:100%" onclick="closeModal('modal-calc')">Selesai (Esc)</button>
    </div>
</div>

<script>
    // Konfigurasi Firebase (Poin 21, 25, 26, 27)
    const firebaseConfig = {
        apiKey: "AIzaSyBgtHGA5JKGHk41XEySIOdpikDqo_UCI9g",
        authDomain: "kasir25-36b45.firebaseapp.com",
        projectId: "kasir25-36b45",
        storageBucket: "kasir25-36b45.firebasestorage.app",
        databaseURL: "https://kasir25-36b45-default-rtdb.asia-southeast1.firebasedatabase.app/",
        messagingSenderId: "841813796050",
        appId: "1:841813796050:web:c0a74488c7c4af1975390b",
        measurementId: "G-FFD99B27D6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [];
    let allSales = [];
    let shiftId = localStorage.getItem('shiftId') || Date.now().toString();
    localStorage.setItem('shiftId', shiftId);
    let currentStaff = localStorage.getItem('currentStaff') || "-";
    let selectedIdx = null;

    // Sinkronasi Cepat Realtime Database
    db.ref('products').on('value', (snap) => {
        const val = snap.val();
        products = val ? Object.entries(val).map(([id, data]) => ({ id, ...data })) : [];
        renderAll();
    });

    db.ref('sales').on('value', (snap) => {
        const val = snap.val();
        allSales = val ? Object.values(val) : [];
        renderAll();
    });

    function openModal(id) { 
        document.getElementById(id).style.display = 'flex';
        const inp = document.querySelector(`#${id} input`);
        if(inp) setTimeout(() => inp.focus(), 100);
    }
    
    function closeModal(id) { 
        if(!id) {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        } else {
            document.getElementById(id).style.display = 'none';
        }
    }

    // Format Titik Otomatis (Poin 13)
    function formatRupiah(el) {
        let val = el.value.replace(/\D/g, "");
        el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateStaff() {
        currentStaff = document.getElementById('staff-input').value || "-";
        localStorage.setItem('currentStaff', currentStaff);
        closeModal('modal-staff');
        renderAll();
    }

    // Simpan Barang (Poin 17 & 22)
    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const stockG = parseInt(document.getElementById('p-stock-gudang').value) || 0;
        const stockK = parseInt(document.getElementById('p-stock-kulkas').value) || 0;
        const price = parseInt(document.getElementById('p-price').value.replace(/\./g, '')) || 0;
        
        if(!name) return alert("Nama barang wajib diisi!");
        
        db.ref('products/' + name.replace(/[\.\#\$\[\]\s]/g, '_')).set({
            name, stockG, stockK, price
        }).then(() => {
            closeModal('modal-input');
            ['p-name', 'p-stock-gudang', 'p-stock-kulkas', 'p-price'].forEach(id => document.getElementById(id).value = "");
        });
    }

    function openSaleModal(i) {
        selectedIdx = i;
        const p = products[i];
        document.getElementById('info-barang-jual').innerText = `${p.name} - Rp ${p.price.toLocaleString('id-ID')}`;
        document.getElementById('buy-qty').value = 1;
        openModal('modal-sale');
    }

    async function processSale() {
        const qty = parseInt(document.getElementById('buy-qty').value);
        const p = products[selectedIdx];
        if(qty > p.stockK) return alert("Stok kulkas tidak cukup!");
        
        const total = p.price * qty;
        const saleId = db.ref('sales').push().key;

        const updates = {};
        updates['/sales/' + saleId] = {
            shiftId, 
            time: new Date().toLocaleString('id-ID'),
            name: p.name, 
            qty, 
            total, 
            staff: currentStaff
        };
        updates['/products/' + p.id + '/stockK'] = p.stockK - qty;

        await db.ref().update(updates);
        closeModal('modal-sale');
        
        // Tampilkan Kalkulator (Poin 18)
        document.getElementById('calc-total').innerText = "RP. " + total.toLocaleString('id-ID');
        document.getElementById('calc-bayar').value = "";
        document.getElementById('calc-result').innerText = "";
        openModal('modal-calc');
    }

    function hitungKembalian() {
        const total = parseInt(document.getElementById('calc-total').innerText.replace(/[^\d]/g, ''));
        const bayar = parseInt(document.getElementById('calc-bayar').value.replace(/\./g, '')) || 0;
        const kembalian = bayar - total;
        
        const resDiv = document.getElementById('calc-result');
        if(kembalian < 0) {
            resDiv.innerText = "UANG KURANG!";
            resDiv.style.color = "red";
        } else {
            resDiv.innerText = "KEMBALIAN: RP. " + kembalian.toLocaleString('id-ID');
            resDiv.style.color = "var(--danger)";
        }
    }

    function renderAll() {
        const shiftSales = allSales.filter(s => s.shiftId === shiftId);
        const totalShift = shiftSales.reduce((a, b) => a + b.total, 0);

        // Render Rak (Poin 10)
        document.getElementById('pos-grid').innerHTML = products.map((p, i) => `
            <div class="product-item" onclick="openSaleModal(${i})">
                <div class="p-name">${p.name}</div>
                <div class="p-stock">Kulkas: ${p.stockK}</div>
                <div class="p-price">Rp ${p.price.toLocaleString('id-ID')}</div>
            </div>
        `).join('');

        // Render Riwayat
        document.getElementById('sales-log').innerHTML = [...shiftSales].reverse().map(s => `
            <tr><td>${s.time.split(' ')[1]}</td><td>${s.name}</td><td>${s.qty}</td><td>${s.total.toLocaleString('id-ID')}</td></tr>
        `).join('');

        // Render Pop-up Stok (Poin 6)
        document.getElementById('stock-list').innerHTML = products.map((p) => `
            <tr>
                <td>${p.name}</td>
                <td style="font-weight:bold; color:var(--primary)">${p.stockG}</td>
                <td>${p.stockK}</td>
                <td>
                    <button class="btn-green" style="padding:4px 8px; margin:0; width:auto; display:inline-block; font-size:0.8rem;" onclick="addStockGudang('${p.id}')">‚ûï Stok G</button>
                    <button class="btn-blue" style="padding:4px 8px; font-size:0.8rem;" onclick="moveStock('${p.id}')">üì¶ Pindah ke K</button>
                </td>
            </tr>
        `).join('');

        document.getElementById('staff-label').innerText = currentStaff;
        document.getElementById('display-total-val').innerText = `= RP. ${totalShift.toLocaleString('id-ID')}`;
    }

    // Tambah Stok Gudang (Poin 28)
    function addStockGudang(id) {
        const p = products.find(x => x.id === id);
        const qty = parseInt(prompt(`Masukkan JUMLAH TAMBAHAN stok untuk ${p.name}:`, "0"));
        if(!isNaN(qty) && qty > 0) {
            db.ref('products/'+id).update({ stockG: p.stockG + qty });
        }
    }

    function moveStock(id) {
        const p = products.find(x => x.id === id);
        const qty = parseInt(prompt(`Pindah berapa dari Gudang ke Kulkas untuk ${p.name}?\n(Stok Gudang: ${p.stockG})`, "0"));
        if(!isNaN(qty) && qty > 0 && qty <= p.stockG) {
            db.ref('products/'+id).update({ stockG: p.stockG - qty, stockK: p.stockK + qty });
        } else if (qty > p.stockG) {
            alert("Stok gudang tidak mencukupi!");
        }
    }

    function resetShift() {
        if(confirm("Tampilan riwayat layar akan dibersihkan untuk shift baru. Data di database TETAP AMAN.")) {
            shiftId = Date.now().toString();
            localStorage.setItem('shiftId', shiftId);
            location.reload();
        }
    }

    // PDF Laporan (Poin 4 & 29)
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const sales = allSales.filter(s => s.shiftId === shiftId);
        const tgl = new Date().toLocaleDateString('id-ID');
        const totalP = sales.reduce((a, b) => a + b.total, 0);
        
        doc.setFontSize(10);
        doc.text(tgl, 160, 10); // Tanggal kanan atas (Poin 4)
        doc.setFontSize(16);
        doc.text("LAPORAN SHIFT KASIR 25", 14, 20);
        doc.setFontSize(11);
        doc.text(`Petugas: ${currentStaff}`, 14, 28);

        doc.autoTable({
            head: [['Jam', 'Barang', 'Qty', 'Total']],
            body: sales.map(s => [s.time.split(' ')[1], s.name, s.qty, s.total.toLocaleString()]),
            startY: 35
        });

        const finalY = doc.lastAutoTable.finalY;
        // Total Penjualan Shift (Poin 29)
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`TOTAL PENJUALAN SHIFT: RP. ${totalP.toLocaleString('id-ID')}`, 14, finalY + 10);
        
        doc.setFontSize(11);
        doc.text("STOK TERAKHIR:", 14, finalY + 20);
        doc.autoTable({
            head: [['Nama Barang', 'Gudang', 'Kulkas']],
            body: products.map(p => [p.name, p.stockG, p.stockK]),
            startY: finalY + 25
        });
        doc.save(`Laporan_Shift_${tgl}.pdf`);
    }

    // Keyboard Control (Poin 23 & 24)
    window.addEventListener('keydown', (e) => {
        if (e.key === "Escape") closeModal();
        if (e.key === "Enter") {
            const openModals = Array.from(document.querySelectorAll('.modal')).filter(m => m.style.display === 'flex');
            if(openModals.length > 0) {
                const currentModalId = openModals[openModals.length - 1].id;
                if(currentModalId === 'modal-staff') updateStaff();
                else if(currentModalId === 'modal-input') saveProduct();
                else if(currentModalId === 'modal-sale') processSale();
                else if(currentModalId === 'modal-calc') hitungKembalian();
            }
        }
    });

    // Clock (Poin 8)
    setInterval(() => {
        const now = new Date();
        const jam = now.getHours().toString().padStart(2,'0');
        const menit = now.getMinutes().toString().padStart(2,'0');
        const tgl = now.getDate().toString().padStart(2,'0');
        const bln = (now.getMonth()+1).toString().padStart(2,'0');
        const thn = now.getFullYear();
        document.getElementById('clock').innerText = `${jam}:${menit} - ${tgl}/${bln}/${thn}`;
    }, 1000);

    window.onload = renderAll;
</script>

</body>
</html>