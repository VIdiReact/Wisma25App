<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --edit: #9b59b6;
            --adjust: #e67e22;
            --price: #34495e;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f7f6; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
		.btn-back { 
			background: var(--accent); 
			color: white; 
			padding: 8px 15px; 
			border-radius: 5px; 
			text-decoration: none; 
			font-weight: bold; 
			font-size: 0.8rem; 
			border: none; 
			cursor: pointer; 
    
			/* TAMBAHAN PENTING: */
			width: auto;   /* Mencegah tombol melar 100% */
			margin: 0;     /* Menghapus margin bawaan global agar rapi di tengah vertikal */
		}
        .container { display: grid; grid-template-columns: 1.4fr 1.1fr; gap: 20px; padding: 20px; flex: 1; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .product-item { background: var(--light); padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .product-item:hover { background: var(--accent); color: white; }
        
        input, select, button { padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; color: white; transition: 0.2s; }
        button:active { opacity: 0.7; }
        
        .btn-add { background: var(--success); }
        .btn-move { background: var(--warning); font-size: 0.7rem; }
        .btn-adjust { background: var(--adjust); font-size: 0.7rem; }
        .btn-price { background: var(--price); font-size: 0.7rem; }
        .btn-edit { background: var(--edit); font-size: 0.7rem; }
        .btn-reset { background: var(--danger); }
        .btn-export { background: var(--accent); }
        .btn-del-item { background: var(--danger); padding: 2px 8px; width: auto; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        table th { background: #f8f9fa; color: #333; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        
        .total-amount { font-size: 1.8rem; color: var(--success); font-weight: bold; margin: 10px 0; }
        .badge { background: #ddd; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem; color: #333; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .action-stack { display: flex; flex-direction: column; gap: 4px; }
    </style>
</head>
<body>

<header>
    <div><strong>KASIR 25</strong> | Petugas: <span id="display-karyawan">-</span></div>
	<button class="btn-back" onclick="location.href='index3.html'">üè† KEMBALI KE ROOM MONITOR</button>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div>
        <div class="card">
            <h3>Menu Penjualan</h3>
            <div class="product-grid" id="pos-grid"></div>
        </div>

        <div class="card">
            <h3>Riwayat Penjualan Shift</h3>
            <table id="table-sales">
                <thead>
                    <tr>
                        <th>Jam</th>
                        <th>Barang</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="sales-log"></tbody>
            </table>
        </div>
    </div>

    <div>
        <div class="card">
            <h3>Status Shift</h3>
            <input type="text" id="staff-name" placeholder="Nama Karyawan" onchange="updateStaff()">
            <div class="total-amount" id="total-revenue">Rp 0</div>
            
            <button onclick="manualRefresh()" style="background: #8e44ad; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-weight: bold;">
                üîÑ Sinkron Cloud Sekarang
            </button>
            
            <button class="btn-export" onclick="exportPDF()">Ekspor PDF (Penjualan & Stok)</button>
            <button class="btn-reset" onclick="resetShift()">Reset Shift / Ganti Petugas</button>
            <p style="font-size: 0.7rem; color: #666; margin-top: 5px; text-align: center;">
                *Data otomatis sinkron setiap 30 detik
            </p>
        </div>

        <div class="card">
            <h3>Input Barang Baru</h3>
            <input type="text" id="p-name" placeholder="Nama Barang">
            <input type="number" id="p-stock-gudang" placeholder="Stok Gudang">
            <input type="number" id="p-stock-kulkas" placeholder="Stok Kulkas">
            <input type="number" id="p-price" placeholder="Harga Jual">
            <button class="btn-add" onclick="saveProduct()">Simpan Barang</button>
            
            <hr>
            <h4>Kelola Barang & Stok</h4>
            <table id="stock-table">
                <thead>
                    <tr>
                        <th>Barang</th>
                        <th>Stok (G/K)</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="stock-list"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 id="modal-title">Jumlah Beli</h3>
        <p id="modal-stock-info"></p>
        <input type="number" id="buy-qty" value="1" min="1">
        <button class="btn-add" onclick="processSale()">Konfirmasi</button>
        <button onclick="closeModal()" style="background:#ccc; color: black; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">Batal</button>
    </div>
</div>

<script>
    // 1. URL WEB APP GOOGLE SCRIPT
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbzTEIV6_93OwKSSPGuJPoe945HeBK5V_jt-FPLTWF2n7WlFkzUoDjrTDQjv4Qw3YBkw5w/exec"; 

    let products = [];
    let sales = JSON.parse(localStorage.getItem('sales')) || [];
    let currentStaff = localStorage.getItem('currentStaff') || "-";
    let selectedIdx = null;

    // Inisialisasi awal
    document.getElementById('display-karyawan').innerText = currentStaff;
    document.getElementById('staff-name').value = currentStaff === "-" ? "" : currentStaff;
    
    // Ambil data dari Cloud saat aplikasi dibuka
    loadFromCloud();

    // SINKRONISASI OTOMATIS: Menarik data dari cloud setiap 30 detik
    // Ini memastikan Laptop 2 mendapatkan update stok jika Laptop 1 melakukan transaksi
    setInterval(() => {
        console.log("Sinkronisasi otomatis dengan Cloud...");
        loadFromCloud(true); // true menandakan silent reload (tanpa mengganggu user)
    }, 30000); 

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID');
    }, 1000);

    // --- FUNGSI CLOUD ---

    async function loadFromCloud(isSilent = false) {
		try {
			if(!isSilent) console.log("Menarik data dari cloud...");
			const response = await fetch(CLOUD_URL);
			const data = await response.json();
        
			if (data) {
				// Update Produk
				if (data.products) {
					products = data.products;
					localStorage.setItem('products', JSON.stringify(products));
				}
				// Update Penjualan (Tambahkan baris ini)
				if (data.recentSales) {
					sales = data.recentSales; 
					localStorage.setItem('sales', JSON.stringify(sales));
				}
			}
			renderAll();
		} catch (e) {
			console.error("Cloud gagal dimuat.");
			renderAll();
		}
	}

    // Fungsi untuk dipicu tombol refresh manual (opsional jika ingin instan)
    async function manualRefresh() {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Memuat...";
        btn.disabled = true;
        await loadFromCloud();
        btn.innerText = originalText;
        btn.disabled = false;
    }

    async function syncToCloud(type, dataExtra = {}) {
        try {
            const payload = {
                type: type,
                staff: currentStaff,
                ...dataExtra
            };

            if (type === "SYNC_STOCK") {
                payload.products = products;
            }

            // Gunakan await agar proses sinkron selesai sebelum lanjut
            await fetch(CLOUD_URL, {
                method: "POST",
                mode: "no-cors", 
                body: JSON.stringify(payload)
            });
        } catch (e) {
            console.error("Gagal sinkronisasi ke cloud.");
        }
    }

    // --- FUNGSI CORE ---

    function renderAll() {
        renderPOS();
        renderStockTable();
        renderSales();
        updateTotal();
    }

    function updateStaff() {
        currentStaff = document.getElementById('staff-name').value || "-";
        localStorage.setItem('currentStaff', currentStaff);
        document.getElementById('display-karyawan').innerText = currentStaff;
    }

    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const stockG = parseInt(document.getElementById('p-stock-gudang').value) || 0;
        const stockK = parseInt(document.getElementById('p-stock-kulkas').value) || 0;
        const price = parseInt(document.getElementById('p-price').value) || 0;
        
        if(!name) return alert("Nama barang wajib diisi!");
        
        const idx = products.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
        if(idx >= 0) products[idx] = { ...products[idx], stockG, stockK, price };
        else products.push({ name, stockG, stockK, price });
        
        saveData();
        syncToCloud("SYNC_STOCK"); 
        renderAll(); 
        clearForm();
    }

    function renderPOS() {
        const grid = document.getElementById('pos-grid');
        grid.innerHTML = products.map((p, i) => `
            <div class="product-item" onclick="openSaleModal(${i})">
                <strong>${p.name}</strong><br>
                <span class="badge">Kulkas: ${p.stockK}</span><br>
                <small>Rp ${p.price.toLocaleString()}</small>
            </div>
        `).join('');
    }

    function renderStockTable() {
        const list = document.getElementById('stock-list');
        list.innerHTML = products.map((p, i) => `
            <tr>
                <td><strong>${p.name}</strong><br><small>Rp ${p.price.toLocaleString()}</small></td>
                <td>G: ${p.stockG}<br>K: ${p.stockK}</td>
                <td>
                    <div class="action-stack">
                        <button class="btn-move" onclick="moveStock(${i})">Pindah Kulkas</button>
                        <button class="btn-adjust" onclick="adjustStockValue(${i})">Ubah Stok</button>
                        <button class="btn-price" onclick="adjustPriceValue(${i})">Ubah Harga</button>
                        <button class="btn-edit" onclick="editProductName(${i})">Ubah Nama</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function moveStock(index) {
        const moveQty = parseInt(prompt(`Pindah berapa ke kulkas? (Gudang: ${products[index].stockG})`, "0"));
        if(moveQty > 0 && moveQty <= products[index].stockG) {
            products[index].stockG -= moveQty; products[index].stockK += moveQty;
            saveData();
            syncToCloud("SYNC_STOCK");
            renderAll();
        } else if (moveQty > 0) alert("Stok gudang tidak cukup!");
    }

    function adjustStockValue(index) {
        const newG = prompt("Set ulang STOK GUDANG:", products[index].stockG);
        const newK = prompt("Set ulang STOK KULKAS:", products[index].stockK);
        if (newG !== null && newK !== null) {
            products[index].stockG = parseInt(newG) || 0;
            products[index].stockK = parseInt(newK) || 0;
            saveData();
            syncToCloud("SYNC_STOCK");
            renderAll();
        }
    }

    function adjustPriceValue(index) {
        const newPrice = prompt(`Ubah harga untuk ${products[index].name}:`, products[index].price);
        if (newPrice !== null) {
            products[index].price = parseInt(newPrice) || 0;
            saveData();
            syncToCloud("SYNC_STOCK");
            renderAll();
        }
    }

    function editProductName(index) {
        const oldName = products[index].name;
        const newName = prompt("Ubah nama barang:", oldName);
        if (newName) { 
            products[index].name = newName; 
            saveData();
            syncToCloud("SYNC_STOCK");
            renderAll(); 
        }
    }

    function openSaleModal(i) {
        selectedIdx = i;
        document.getElementById('modal-title').innerText = products[i].name;
        document.getElementById('modal-stock-info').innerText = `Tersedia di kulkas: ${products[i].stockK}`;
        document.getElementById('modal').style.display = 'flex';
    }

    async function processSale() {
        const qty = parseInt(document.getElementById('buy-qty').value);
        const p = products[selectedIdx];
        if(qty > p.stockK) return alert("Stok kulkas tidak cukup!");
        if(qty <= 0) return alert("Jumlah tidak valid!");
        
        const saleData = {
            id: Date.now(),
            time: new Date().toLocaleString('id-ID'),
            name: p.name,
            qty: qty,
            total: p.price * qty,
            staff: currentStaff
        };

        p.stockK -= qty;
        sales.push(saleData);
        
        saveData();
        renderAll(); 
        closeModal();

        // Proses Cloud di background agar aplikasi tetap cepat
        await syncToCloud("SALE", saleData);
        await syncToCloud("SYNC_STOCK");
    }

    function deleteSaleItem(id) {
        if(confirm("Batalkan item ini? Stok kulkas akan dikembalikan di lokal.")) {
            const saleIdx = sales.findIndex(s => s.id === id);
            if(saleIdx > -1) {
                const item = sales[saleIdx];
                const prodIdx = products.findIndex(p => p.name === item.name);
                if(prodIdx > -1) products[prodIdx].stockK += item.qty;
                sales.splice(saleIdx, 1);
                saveData();
                syncToCloud("SYNC_STOCK");
                renderAll();
            }
        }
    }

    function resetShift() {
        if(confirm("Hapus riwayat penjualan shift ini dari layar?")) {
            sales = []; 
            localStorage.setItem('sales', JSON.stringify(sales));
            renderAll();
        }
    }

    function saveData() {
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('sales', JSON.stringify(sales));
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    function renderSales() {
        document.getElementById('sales-log').innerHTML = sales.map(s => `
            <tr><td>${s.time.split(' ')[1] || s.time}</td><td>${s.name}</td><td>${s.qty}</td><td>${s.total.toLocaleString()}</td><td><button class="btn-del-item" onclick="deleteSaleItem(${s.id})">‚úñ</button></td></tr>
        `).reverse().join('');
    }

    function updateTotal() {
        const total = sales.reduce((sum, s) => sum + s.total, 0);
        document.getElementById('total-revenue').innerText = `Rp ${total.toLocaleString()}`;
    }

    function clearForm() {
        ['p-name', 'p-stock-gudang', 'p-stock-kulkas', 'p-price'].forEach(id => document.getElementById(id).value = "");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text("LAPORAN PENJUALAN & STOK SHIFT", 14, 15);
        doc.setFontSize(11);
        doc.text(`Kasir: ${currentStaff}`, 14, 25);
        doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 32);

        doc.setFontSize(14);
        doc.text("A. Detail Penjualan", 14, 45);
        const salesData = sales.map(s => [s.time, s.name, s.qty, `Rp ${s.total.toLocaleString()}`]);
        doc.autoTable({
            head: [['Waktu', 'Nama Barang', 'Qty', 'Total Harga']],
            body: salesData,
            startY: 50,
            theme: 'grid'
        });

        const finalYsales = doc.lastAutoTable.finalY;
        doc.text(`Total Pemasukan: Rp ${sales.reduce((a,b)=>a+b.total,0).toLocaleString()}`, 14, finalYsales + 10);

        doc.text("B. Laporan Sisa Stok", 14, finalYsales + 25);
        const stockData = products.map(p => [p.name, p.stockG, p.stockK, p.stockG + p.stockK]);
        doc.autoTable({
            head: [['Nama Barang', 'Gudang', 'Kulkas', 'Total']],
            body: stockData,
            startY: finalYsales + 30,
            theme: 'striped'
        });

        doc.save(`Laporan_${currentStaff}.pdf`);
    }
</script>
</body>
</html>